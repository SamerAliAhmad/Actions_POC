<div class="flex flex-col flex-auto overflow-hidden p-4">
    <form #kpiComparisonForm="ngForm" class="flex flex-col flex-auto overflow-y-auto overflow-x-hidden"
        *ngIf="!isShowGeneratedData && !isDataLoading">
        <div class="flex flex-row gap-4 items-center mb-4">
            <mat-form-field class="w-full" [floatLabel]="'always'" (click)="$event.stopPropagation()">
                <mat-label>Data Level</mat-label>
                <mat-select matInput placeholder="Data Level" autocomplete="off"
                    [(ngModel)]="oAccess_Control_Object.DATA_LEVEL_SETUP_ID" name="DATA_LEVEL_SETUP_ID"
                    (selectionChange)=" oAccess_Control_Object.LEVEL_ID = null;" required>
                    <mat-option *ngFor="let data_access_level_setup of oList_Data_access_level_setup"
                        [value]="data_access_level_setup.SETUP_ID">
                        {{data_access_level_setup.VALUE}}
                    </mat-option>
                </mat-select>
            </mat-form-field>
            <mat-form-field class="w-full" [floatLabel]="'always'" (click)="$event.stopPropagation()">
                <mat-label>Object</mat-label>
                <mat-select matInput [placeholder]="getSetupValue(oAccess_Control_Object.DATA_LEVEL_SETUP_ID)"
                    [(ngModel)]="oAccess_Control_Object.LEVEL_ID" name="LEVEL_ID" required
                    [disabled]="!getObjects(oAccess_Control_Object)?.length" (selectionChange)="Filter_KPI_List()"
                    autocomplete="off">
                    <mat-option>
                        <ngx-mat-select-search #selectObjectSearch
                            [placeholderLabel]="'Search for '+getSetupValue(oAccess_Control_Object.DATA_LEVEL_SETUP_ID)"
                            noEntriesFoundLabel="No Matching Sites">
                        </ngx-mat-select-search>
                    </mat-option>
                    <mat-option
                        *ngFor="let object of getObjects(oAccess_Control_Object) | filter: selectObjectSearch.value"
                        [value]="getObjectId(oAccess_Control_Object.DATA_LEVEL_SETUP_ID, object)">
                        {{getObjectName(oAccess_Control_Object.DATA_LEVEL_SETUP_ID,
                        getObjectId(oAccess_Control_Object.DATA_LEVEL_SETUP_ID, object))}}
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </div>
        <mat-form-field class="w-full mb-4" [floatLabel]="'always'">
            <mat-label>KPI</mat-label>
            <mat-select matInput placeholder="Choose a KPI" [(ngModel)]="oOrganization_data_souce_KPI"
                name="oOrganization_data_souce_KPI_ID" required autocomplete="off"
                [disabled]="!oAccess_Control_Object.LEVEL_ID || oList_Filtered_Organization_data_source_kpi?.length === 0">
                <mat-option>
                    <ngx-mat-select-search #selectObjectSearch placeholderLabel="Search for a specific KPI"
                        noEntriesFoundLabel="No Matching Data">
                    </ngx-mat-select-search>
                </mat-option>
                <mat-option
                    *ngFor="let organization_data_source_kpi of oList_Filtered_Organization_data_source_kpi | filter: selectObjectSearch.value"
                    [value]="organization_data_source_kpi">
                    {{organization_data_source_kpi.Kpi.NAME}}
                </mat-option>
            </mat-select>
        </mat-form-field>
        <div class="font-semibold mb-1 text-md">Aggregate By</div>
        <div class="flex flex-row items-center mb-8">
            <mat-button-toggle-group class="grid grid-cols-3 bottom-button-toggle gap-1" [(ngModel)]="oEnum_Timespan"
                name="oEnum_Timespan" required>
                <mat-button-toggle *ngFor="let enum of getEnumsToDisplay() | keyvalue" [value]="enum.value"
                    [ngClass]="[oEnum_Timespan==enum.value ? 'bg-secondaryColor' : '',oEnum_Timespan==enum.value && isDark?'text-white': '']">
                    {{getEnumCollectionValue(enum.value)}}
                </mat-button-toggle>
            </mat-button-toggle-group>
        </div>
        <ng-container *ngIf="oEnum_Timespan">
            <div *ngIf="getMinimumNumberOfDays()!=1" class="text-lg"
                [ngClass]="areDatesValid()?'text-green-500':'text-red-500'">
                The period between start and end dates must be a multiple of
                {{getMinimumNumberOfDays()}} days.</div>
            <div class="flex flex-row gap-4 mb-4">
                <mat-form-field [floatLabel]="'always'" class="w-full">
                    <mat-label>Start Date</mat-label>
                    <input matInput [(ngModel)]="oStart_Date" name="START_DATE" name="START_DATE" required
                        [matDatepicker]="startDatePicker" (click)="startDatePicker.open()" placeholder="Start Date"
                        (keydown)="false" autocomplete="off" [max]="getMaxStartDate()">
                    <mat-datepicker-toggle matSuffix [for]="startDatePicker">
                    </mat-datepicker-toggle>
                    <mat-datepicker #startDatePicker></mat-datepicker>
                    <mat-error>Start Date is required</mat-error>
                </mat-form-field>
                <mat-form-field [floatLabel]="'always'" class="w-full">
                    <mat-label>End Date</mat-label>
                    <input matInput [(ngModel)]="oEnd_Date" name="END_DATE" name="END_DATE" required
                        [matDatepicker]="endDatePicker" [matDatepickerFilter]="endDateFilter"
                        (click)="endDatePicker.open()" placeholder="End Date" (keydown)="false" autocomplete="off"
                        [min]="oStart_Date" [max]="oToday_Date" [disabled]="!oStart_Date">
                    <mat-datepicker-toggle matSuffix [for]="endDatePicker">
                    </mat-datepicker-toggle>
                    <mat-datepicker #endDatePicker></mat-datepicker>
                    <mat-error>End Date is required</mat-error>
                </mat-form-field>
            </div>
        </ng-container>
        <button class="ml-auto min-w-26" mat-flat-button (click)="generateCharts(kpiComparisonForm)"
            [disabled]="kpiComparisonForm.invalid || !areDatesValid()">Generate</button>
    </form>
    <div *ngIf="isDataLoading" class="loader-container absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
        <div class="loader"></div>
    </div>
    <div *ngIf="isShowGeneratedData && !isDataLoading"
        class="flex flex-col flex-auto overflow-y-auto overflow-x-hidden">
        <div class="flex flex-row mb-4 gap-4 items-center">
            <button mat-icon-button matTooltip="Go Back" class="remove-on-pdf" (click)="goBack()">
                <mat-icon [svgIcon]="'heroicons_outline:arrow-left'" class="text-iconColor"></mat-icon>
            </button>
            <div class="text-lg">
                {{(oOrganization_data_souce_KPI.Kpi.NAME)}} on
                {{getObjectName(oAccess_Control_Object.DATA_LEVEL_SETUP_ID,oAccess_Control_Object.LEVEL_ID)}}
                between {{oStart_Date | date : null : TimezoneService.oCurrent_Timezone_Offset}} and {{oEnd_Date | date
                : null : TimezoneService.oCurrent_Timezone_Offset}} aggregated
                {{getEnumCollectionValue(oEnum_Timespan)}}.
            </div>
        </div>
        <div class="w-full h-300 max-h-300 min-h-100">
            <canvas class="w-full h-full" baseChart [options]="oKpi_data.ChartConfiguration.options"
                [type]="oKpi_data.ChartConfiguration.type" [plugins]="oKpi_data.ChartConfiguration.plugins"
                [data]="oKpi_data.ChartConfiguration.data"></canvas>
        </div>
        <div class="ml-2 flex flex-col gap-1">
            <div class="flex flex-row flex-auto justify-between gap-2">
                <mat-button-toggle-group class="w-full bottom-button-toggle" multiple>
                    <mat-button-toggle class="w-full bg-secondaryColor text-white"
                        [ngClass]="[isMinButtonPressed? 'text-gray-600' : 'bg-white']" [checked]="isMinButtonPressed"
                        (change)="isMinButtonPressed = $event.source.checked; Toggle_Min_Value();">
                        Minimum
                    </mat-button-toggle>
                    <mat-button-toggle class="w-full bg-secondaryColor text-white"
                        [ngClass]="[isMaxButtonPressed? 'text-gray-600' : 'bg-white']" [checked]="isMaxButtonPressed"
                        (change)="isMaxButtonPressed = $event.source.checked; Toggle_Max_Value();">
                        Maximum
                    </mat-button-toggle>
                    <mat-button-toggle class="w-full bg-secondaryColor text-white"
                        [ngClass]="[isAverageButtonPressed? 'text-gray-600' : 'bg-white']"
                        [checked]="isAverageButtonPressed"
                        (change)="isAverageButtonPressed = $event.source.checked; Toggle_Average_Value();">
                        Average
                    </mat-button-toggle>
                    <mat-button-toggle class="w-full bg-secondaryColor text-white"
                        [ngClass]="[isThresholdInputVisible? 'text-gray-600' : 'bg-white']"
                        [checked]="isThresholdInputVisible"
                        (change)="isThresholdInputVisible = $event.source.checked; Toggle_Threshold_Input();">
                        Benchmark
                    </mat-button-toggle>
                </mat-button-toggle-group>
            </div>
            <div class="flex flex-row items-end w-full gap-3 pr-1" *ngIf="isThresholdInputVisible">
                <mat-form-field class="w-full" [floatLabel]="'always'" subscriptSizing="dynamic">
                    <mat-label>Benchmark</mat-label>
                    <input matInput type="number" [(ngModel)]="threshold" name="threshold">
                </mat-form-field>
                <button class="mb-1" (click)="Toggle_Threshold()" mat-flat-button>Apply</button>
            </div>
        </div>
    </div>
</div>