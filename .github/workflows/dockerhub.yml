name: Build and Push Docker Images

on:
  push:
    tags:
      - "v*"

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKER_TOKEN }}
  DOCKERHUB_REPOSITORY: districtnex

jobs:
  # ui:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3

  #     - name: Login to Docker Hub
  #       uses: docker/login-action@v2
  #       with:
  #         username: ${{ env.DOCKERHUB_USERNAME }}
  #         password: ${{ env.DOCKERHUB_TOKEN }}

  #     - name: Build and Push UI
  #       uses: docker/build-push-action@v4
  #       with:
  #         push: true
  #         tags: ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}:ui-${{ github.ref_name }}
  #         context: DistrictNex_UI
  #         file: DistrictNex_UI/Dockerfile

  # admin:
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3

  #     - name: Login to Docker Hub
  #       uses: docker/login-action@v2
  #       with:
  #         username: ${{ env.DOCKERHUB_USERNAME }}
  #         password: ${{ env.DOCKERHUB_TOKEN }}

  #     - name: Build and Push Admin
  #       uses: docker/build-push-action@v4
  #       with:
  #         push: true
  #         tags: ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}:admin-${{ github.ref_name }}
  #         context: DistrictNex_Admin
  #         file: DistrictNex_Admin/Dockerfile

  # microservices:
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       name:
  #         [
  #           Area-Management,
  #           Asset-Management,
  #           Cloud-Interface,
  #           Dimension-Management,
  #           District-Management,
  #           Entity-Management,
  #           File-Management,
  #           Floor-Management,
  #           Insights-Management,
  #           KPI-Extraction-Engine,
  #           KPI-Management,
  #           Method-Monitoring,
  #           Mobility-Dimension,
  #           Organization-Management,
  #           Platform-Logging,
  #           Region-Management,
  #           Reporting,
  #           Security-Dimension,
  #           Settings-Management,
  #           ShareView,
  #           Site-Management,
  #           Smart-Living-Dimension,
  #           Space-Management,
  #           Sustainability-Dimension,
  #           Top-Level-Management,
  #           User-Authentication,
  #           User-Management,
  #           Video-AI-Engine-Management,
  #           Api-Gateway,
  #           Data-Creation-Cron,
  #           Data-Retention-Cron,
  #           Mobility-Dimension-Cron,
  #           Security-Dimension-Cron,
  #           SignalR-Realtime-Server,
  #           Smart-Living-Dimension-Cron,
  #           Sustainability-Dimension-Cron,
  #           Video-AI-Engine-Management-Cron,
  #           Wifi-Signal-Cron,
  #         ]

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3

  #     - name: Login to Docker Hub
  #       uses: docker/login-action@v2
  #       with:
  #         username: ${{ env.DOCKERHUB_USERNAME }}
  #         password: ${{ env.DOCKERHUB_TOKEN }}

  #     - name: Build and Push ${{ matrix.name }}
  #       uses: docker/build-push-action@v4
  #       with:
  #         push: true
  #         tags: ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}:${{ matrix.name }}-${{ github.ref_name }}
  #         context: Microservices
  #         file: Microservices/${{ matrix.name }}-Dockerfile

  run-script:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: me-central-1

      - name: Run script
        run: |
          bash Kubernetes/setup_cluster.sh dev
